{% extends 'base.html' %}
{% load auth_extras %}
{% block title %} Заказ №{{current_order.id}} {% endblock %}

{% block content %}
    <h1>{{ current_order.topic.name }}</h1>
    <p>Клиент: <a href="{% url 'photo_store:show_profile' pk=current_order.owner.id %}">{{ current_order.owner.username }}</a></p>
    <p>Описание: {{ current_order.text }}</p>
    <p>Цена: {{ current_order.price }}</p>
    {% if not is_user_has_response and current_order.owner != user and not accepted_response and user|has_group:"Photographers"%}
        <form action="{% url 'photo_store:create_response' pk=current_order.id %}" method="POST">
            {% csrf_token %}
            <h2>Отклик на заказ:</h2>
            {{ form.as_p }}
            <input type="submit" value="Ответить">
            <p><a href="{% url 'photo_store:orders' %}}">назад</a></p>
        </form>

    <h1>Создать отклик ajax</h1>
    <form id="create_response_ajax_form" method="POST">
        {% csrf_token %}
        {{ ajax_form.as_p }}
        <input type="submit" value="Ответить">
    </form>
    <a href='#' id="test-link">Тест</a>
    <p id="answer"></p>
    <a href='#' id="create-link">TestCreate</a>
    <script>
        function getCookie(name)
        {
              let matches = document.cookie.match(new RegExp(
                "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
              ));
              return matches ? decodeURIComponent(matches[1]) : undefined;
        }

        let link = document.getElementById('test-link');

        link.addEventListener('click', function()
        {
            let sender = new XMLHttpRequest();
            sender.open('GET', '/test_ajax/', true);
            sender.send();
            sender.onreadystatechange = function()
                {
                    if(sender.readyState != 4)
                    {
                       return;
                    }
                    if(sender.status != 200)
                    {
                        alert(sender.status, ': ', sender.statusText);
                    }
                    let answer_block = document.getElementById('answer');
                    let order = JSON.parse(sender.responseText);
                    console.log(order);
                    answer_block.textContent = order.text;
                }
        });

        let create_link = document.getElementById('create-link');

        create_link.addEventListener('click', function()
        {
            let sender = new XMLHttpRequest();
            sender.open('POST', '/test_create_response_ajax/{{current_order.id}}/', true);
            sender.setRequestHeader('X-CSRFToken', getCookie('csrftoken'))
            sender.setRequestHeader('Content-Type', 'application/json')
            let form = document.getElementById('create_response_ajax_form');
            let response_data = {};
            for(field of form)
            {
                response_data[field.name] = field.value
            }
            let json_data = JSON.stringify(response_data);
            sender.send(json_data);
            sender.onreadystatechange = function()
                {
                     if(sender.readyState != 4)
                    {
                       return;
                    }
                    if(sender.status != 200)
                    {
                        alert(sender.status, ': ', sender.statusText);
                    }

                    console.log(sender.responseText);
                }
        });
    </script>

    {% elif not user.is_photographer %}
        <p><a href="{% url 'photo_store:orders' %}">назад</a></p>
    {% elif current_order.owner == user and not accepted_response %}
        <p>Это ваш заказ</p>
        <p><a href="{% url 'photo_store:edit_order' pk=current_order.id %}">Редактировать</a></p>
        <p><a href="{% url 'photo_store:del_order' pk=current_order.id %}">Удалить заказ</a></p>
        <p><a href="{% url 'photo_store:orders' %}">назад</a></p>
    {% elif current_order.owner == user and accepted_response %}
        <p>Это ваш заказ</p>
        <p><a href="{% url 'photo_store:orders' %}">назад</a></p>
<!--        <p><a href="edit/">Редактировать</a></p>-->
    {% elif current_order.owner != user and accepted_response %}
        <p>Заказ закрыт для откликов</p>
        <p><a href="{% url 'photo_store:orders' %}">назад</a></p>
    {% else %}
        <p>Вы уже оставили отклик на этот заказ</p>
        <p><a href="{% url 'photo_store:orders' %}">назад</a></p>
    {% endif %}
    {% if accepted_response and current_order.owner == user %}
        {% if not accepted_response.rate or not accepted_response.comment %}
            <form action="{% url 'photo_store:create_rate_response' pk=current_order.id %}" method="POST">
                {% csrf_token %}
                {{ rate_response_form.as_p }}
                <input type="submit" value="Оставить оценку">
            </form>
        {% endif %}
    {% endif %}
    {% if not accepted_response %}
        <h2>Откликнулись:</h2>
            {% if current_order.owner == request.user %}
                {% for response in current_order.response_set.all %}
                    <p>Рейтинг фотографа: {{ response.photographer.avg_rate }}</p>
                    <a href="{% url 'photo_store:show_profile' pk=response.photographer_id %}"><p>{{ response.photographer }}</p></a>
                    <p>{{ response.text }}</p>
                    <p>Мои работы:</p>
                    {% for photo in photo_list %}
                        {% if photo.photographer == response.photographer and photo.response and photo.response.order.topic == current_order.topic %}
                            <a href="{% url 'photo_store:order' pk=photo.response.order.id %}"><img src="{{ photo.image.url }}" style="width: 15%"></a>
                        {% endif %}
                    {% endfor %}
                    <p><a href="{% url 'photo_store:select_response' pk=response.id %}"><input type="submit" value="выбрать"></a></p>
                    ======================================
                {% endfor %}
            {% else %}
                {% for response in current_order.response_set.all %}
                    <a href="{% url 'photo_store:show_profile' pk=response.photographer.id %}"><p>{{ response.photographer }}</p></a>
                {% endfor %}
            {% endif %}
    {% else %}
        <p>Исполнитель: <a href="{% url 'photo_store:show_profile' pk=accepted_response.photographer.id %}">{{ accepted_response.photographer }}</a></p>
        {% if not current_order.is_public and current_order.owner == request.user or accepted_response.photographer == request.user%}
            <p><h2>Фотографии:</h2></p>
            {% for photo in photo_list %}
                <img src="{{ photo.image.url }}" style="width: 15%">
            {% endfor %}
        {% elif current_order.is_public %}
            <p><h2>Фотографии:</h2></p>
            {% for photo in photo_list %}
                <img src="{{ photo.image.url }}" style="width: 15%">
            {% endfor %}
        {% else %}
            <h3>Заказчик ограничил доступ к материалам заказа</h3>
        {% endif %}
    {% endif %}
    {% if request.user|check_permission:'can_execute' and accepted_response.photographer == request.user %}
        <p><h3>загрузить фотографии</h3></p>
        <form action="{% url 'photo_store:create_response_photo' pk=current_order.id %}" method="POST" enctype="multipart/form-data">
            {% csrf_token %}
            {{ photo_form.as_p }}
            <p><input type="submit" value="Добавить"></p>
        </form>
    {% endif %}
{% endblock %}